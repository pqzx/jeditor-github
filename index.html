<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Messages Editor</title>
  <link rel='stylesheet' href='css/style.css'>
  <link rel='stylesheet' href='//cdn.jsdelivr.net/foundation/5.0.2/css/foundation.min.css'>
  <script src="jsoneditor.js"></script>
  <script>
    // Set the default CSS theme and icon library globally
    JSONEditor.defaults.theme = 'foundation5';
  </script>
</head>

<body>
  <h1>Messages Editor</h1>

  <div>
    <label for="source">Github url to file:</label>
    <input type="text" id="source" name="source">
    <button id="get_source">Retrieve file</button>
  </div>

  <div>
    <label for="username">Username:</label>
    <input type="text" id="username" name="username">
  </div>

  <div>
    <label for="pass">Password:</label>
    <input type="password" id="pass" name="password">
  </div>

  <div>
    <label for="commitmsg">Commit message:</label>
    <input type="text" id="commitmsg" name="commitmsg" value="Updated with message editor">
  </div>
  <button id='submit'>Commit changes (enter login details)</button>

  <div id='editor_holder'></div>

  <script>
    // Initialize the editor
    var editor = new JSONEditor(document.getElementById('editor_holder'), {

      // The schema for the editor
      schema: {
        type: "array",
        title: "Messages",
        //format: "table",
        items: {
          type: "object",
          title: "Message",
          headerTemplate: "{{i1}}",
          options: {
            disable_edit_json: true,
            disable_properties: true,
          },
          properties:
          {
            "content": {
              "type": "string",
              "format": "textarea",
              options: {
                input_height: "100px",
                //input_width: "450px",
                //expand_height: true,
              }
            }
          }
        }
      },

      // Disable additional properties
      no_additional_properties: true,
      disable_collapse: true,
      disable_array_delete_last_row: true,

      // Require all properties by default
      required_by_default: true
    });

    // retrieve json file
    document.getElementById("get_source").addEventListener("click", function () {
      if (editor.getValue().length > 0) {
        if (confirm('Are you sure you wish to retrieve this file? Doing so will overwrite unsaved changes on this page.') === false) {
          return;
        }
      }

      var source = document.getElementById("source");
      var parts = source.value.split('/');
      // This relies on the github url to not change
      var gh = {
        owner: parts[3],
        repo: parts[4],
        branch: parts[6],
        path_to_file: parts.splice(7).join('/')
      }
      var api = "https://api.github.com/repos/" + gh.owner + '/' + gh.repo + '/contents/' + gh.path_to_file;

      var request = new XMLHttpRequest();
      request.open('GET', api, true);
      request.onload = function () {

        var data = JSON.parse(this.response);
        var content = atob(data.content);
        var sha = data.sha;
        var starting_value = JSON.parse(content);

        editor.setValue(starting_value);

        // 2 week cycle of active days
        var days = [1, 3, 4, 6, 9, 11, 13, 14]

        function getRandomTime() {
          // Return a random hour between 10 and 22
          return Math.floor(Math.random() * Math.floor(12) + 10);
        }

        // create response
        var uname = document.getElementById('username');
        var pword = document.getElementById('pass');

        // Hook up the submit button to json and send to github
        document.getElementById('submit').addEventListener('click', function () {
          // Get the value from the editor
          var messages = editor.getValue();
          // create the json we are interested in
          var msgjson = []
          for (var i = 0; i < messages.length; i++) {
            var msg = {
              id: i,
              day: days[i % days.length] + Math.floor(i / days.length) * 14,
              hours: getRandomTime(),
              content: messages[i]["content"]
            }
            msgjson.push(msg);
          }

          // setup connection with github
          var fullstring = uname.value + ':' + pword.value;
          var encoded = btoa(fullstring);
          var reply = new XMLHttpRequest();
          reply.open('PUT', api, true);
          reply.setRequestHeader('Authorization', 'Basic ' + encoded);
          var replyContent = btoa(JSON.stringify(msgjson));
          var update = {
            "message": document.getElementById('commitmsg').value,
            "content": replyContent,
            "sha": sha,
            "branch": gh.branch // push onto same branch
          }
          var params = JSON.stringify(update);
          reply.onload = function () {
            var data = JSON.parse(this.response);
            if (data.hasOwnProperty('commit')) {
              confirm('Commit succeeded.');
            } else {
              confirm('Commit failed. Check login details correct.');
            }
          }
          reply.send(params)
        });

      }

      // set branch
      var params = {
        ref: gh.branch
      }
      request.send(JSON.stringify(params));
    })

  </script>
</body>

</html>